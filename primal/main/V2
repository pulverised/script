local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()
local Players = game:GetService("Players") -- âœ… Add this

local Window = Rayfield:CreateWindow({
   Name = "Primal Cheats",
   Icon = 0,
   LoadingTitle = "Primal Cheats",
   LoadingSubtitle = "by MoldedBlood",
   ShowText = "Primal",
   Theme = "Serenity",
   ToggleUIKeybind = "L",
   DisableRayfieldPrompts = false,
   DisableBuildWarnings = false,
   ConfigurationSaving = {Enabled = true, FolderName = nil, FileName = "Big Hub"},
   Discord = {Enabled = false, Invite = "noinvitelink", RememberJoins = true},
   KeySystem = true,
   KeySettings = {
      Title = "Primal Cheats",
      Subtitle = "Key System",
      Note = "No method of obtaining the key is provided",
      FileName = "Key",
      SaveKey = true,
      GrabKeyFromSite = false,
      Key = {"test"}
   }
})

-- Main Tab
local Tab = Window:CreateTab("Main", 4483362458)
local Section = Tab:CreateSection("ESP")

local TeamESP = {}
local runningTeam = false
local playerConnectionsTeam = {}
local globalConnectionsTeam = {}

local teamColors = {
    ["Inmates"] = Color3.fromRGB(255,165,0),
    ["Guards"] = Color3.fromRGB(0,0,255),
    ["Warden"] = Color3.fromRGB(0,0,139),
    ["Criminals"] = Color3.fromRGB(255,0,0),
}

local function updateHighlightTeam(player)
    if not player or player == Players.LocalPlayer then return end
    local character = player.Character
    if not character then return end
    if character:FindFirstChild("TeamHighlight") then
        character.TeamHighlight:Destroy()
    end
    local teamName = player.Team and player.Team.Name or ""
    local color = teamColors[teamName]
    if not color then return end
    local highlight = Instance.new("Highlight")
    highlight.Name = "TeamHighlight"
    highlight.FillColor = color
    highlight.OutlineColor = color
    highlight.Adornee = character
    highlight.Parent = character
end

local function monitorPlayerTeam(player)
    if not player or player == Players.LocalPlayer then return end
    local conns = {}
    table.insert(conns, player.CharacterAdded:Connect(function()
        if runningTeam then updateHighlightTeam(player) end
    end))
    table.insert(conns, player:GetPropertyChangedSignal("Team"):Connect(function()
        if runningTeam then updateHighlightTeam(player) end
    end))
    if player.Character and runningTeam then updateHighlightTeam(player) end
    playerConnectionsTeam[player] = conns
end

function TeamESP.Start()
    if runningTeam then return end
    runningTeam = true
    for _, player in ipairs(Players:GetPlayers()) do monitorPlayerTeam(player) end
    table.insert(globalConnectionsTeam, Players.PlayerAdded:Connect(function(player)
        monitorPlayerTeam(player)
        if runningTeam then updateHighlightTeam(player) end
    end))
end

function TeamESP.Stop()
    runningTeam = false
    for player, conns in pairs(playerConnectionsTeam) do
        for _, c in ipairs(conns) do
            if c and c.Disconnect then
                c:Disconnect()
            end
        end
    end
    playerConnectionsTeam = {}
    for _, c in ipairs(globalConnectionsTeam) do
        if c and c.Disconnect then
            c:Disconnect()
        end
    end
    globalConnectionsTeam = {}
    for _, player in ipairs(Players:GetPlayers()) do
        if player.Character then
            local highlight = player.Character:FindFirstChild("TeamHighlight")
            if highlight then highlight:Destroy() end
        end
    end
end

-- Rayfield Toggle
local Toggle = Tab:CreateToggle({
    Name = "Team ESP",
    CurrentValue = false,
    Flag = "TeamESP_Toggle",
    Callback = function(Value)
        local success, err = pcall(function()
            if Value then
                TeamESP.Start()
            else
                TeamESP.Stop()
            end
        end)
        if not success then
            warn("Team ESP toggle error: "..err)
        end
    end,
})